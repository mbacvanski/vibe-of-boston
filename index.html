<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
		  integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
		  crossorigin=""/>
	<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
			integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
			crossorigin=""></script>
	<style>
		#map {
			width: 800px;
			height: 600px;
		}

		.ghbtns {
			position: relative;
			top: 4px;
			margin-left: 5px;
		}

		#spidergraphcontainer {
			display: inline-block;
			width: 100%;
			height: 300px;
		}
	</style>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
		  integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"
			integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
			crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
			integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
			crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
			integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
			crossorigin="anonymous"></script>
	<title>Vibe of Boston</title>
</head>

<body>

<div class="w-screen mt-4" style="padding-left:30px; padding-right: 30px">
	<div class="row">
		<div class="col-9">
			<div id="map" style="width: 95%"></div>
		</div>
		<div class="col-3" style="text-align: center">
			<div id="spidergraphcontainer"></div>
		</div>
	</div>
</div>

<script src="dist/leaflet-heat.js"></script>
<script src="dist/spidergraph.js"></script>

<script>
    const defaultWeights = {
        'rating': 10,
        'n_accuracy': 10,
        'reviewcount': 10,
        'popularity': 10,
        'happiness': 10,
        'walkability': 10,
        'transit': 10,
        'liveliness': 10,
    };


    $(document).ready(function () {
        let vibedata;

        const map = L.map('map').setView([42.317048, -71.077208], 11);

        const tiles = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(map);

        $.ajax({
            type: 'GET',
            url: 'dist/data/vibetable.json',
            dataType: 'text',
            success: function (data) {
                vibedata = JSON.parse(data);
                processVibeTable(vibedata, defaultWeights, map);
            }
        });

        $('#spidergraphcontainer').spidergraph({
            // 'fields': ['Average rating', 'Neighborhood perception accuracy', 'Average rating'],
            'fields': ['Enjoyability', 'Consistency', 'Popularity', 'Happiness', 'Walkability', 'Transit', 'Liveliness'],
            'gridcolor': 'rgb(172,172,172)',
            'linear': true,
        });

        $('#spidergraphcontainer').spidergraph('setactivedata', {
            'strokecolor': 'rgba(46,131,230,0.8)',
            'fillcolor': 'rgba(46,131,230,0.6)',
            'data': [defaultWeights['rating'],
                defaultWeights['n_accuracy'],
                defaultWeights['reviewcount'],
                defaultWeights['happiness'],
                defaultWeights['walkability'],
                defaultWeights['transit'],
                defaultWeights['liveliness'],
            ],
            'linear': true,
        });

        $('#spidergraphcontainer').bind('spiderdatachange', function (ev, data) {
            processVibeTable(vibedata, {
                'rating': data[0],
                'n_accuracy': data[1],
                'reviewcount': data[2],
            }, map);
        });
    });

    function processVibeTable(data, weights, map) {
        let biggestVibe = 0;
        let formattedData = [];
        Object.keys(data).forEach(key => {
            const point = data[key];
            const vibe = calcVibe(point, weights);
            const arr = [point['lat'], point['lon'], vibe];
            if (vibe > biggestVibe) {
                biggestVibe = vibe;
            }
            formattedData.push(arr);
        });

        formattedData = formattedData.map(point => [point[0], point[1], point[2] / biggestVibe]);

        map.eachLayer(function (layer) {
            map.removeLayer(layer);
        });
        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(map);
        const heat = L.heatLayer(formattedData, {
            max: 3.5,
            gradient: {0.2: 'blue', 0.55: 'green', 0.8: 'yellow', 1: 'red'}
        }).addTo(map);
    }

    function calcVibe(datapoint, weights) {
        return (weights.n_accuracy * datapoint['neighborhood_accuracy'])
            + (weights.reviewcount * datapoint['num_reviews'])
            + (weights.rating * datapoint['rating']);
    }

</script>
</body>
</html>